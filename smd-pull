#!/bin/bash

# the idea is (where == is a bi-directional pipe) :
#
#   ssh foo smd-server == tee log == smd-client
#

set -e
#set -x
cd

PREFIX="@PREFIX@"
if [ `echo $PREFIX | cut -c -1` = "@" ]; then
	SMDROOT=~/SYNC/smd
	echo "smd-pull not installed, assuming smd-common is in $SMDROOT"
else
	SMDROOT=$PREFIX/share/smd
fi

. $SMDROOT/smd-common

($MITM $CtS > $LtS) < $CtL &
LOGGER1=$!

($MITM $StC > $LtC) < $StL &
LOGGER2=$!

($SMDCLIENT $VERBOSE < $LtC 2> $CL) > $CtL &
CLIENT=$!

($SSH $SERVERNAME $SMDSERVER $VERBOSE $CLIENTNAME $MAILBOX < $LtS 2> $SL) > $StL &
SERVER=$!

EXITCODE=0
wait $SERVER || EXITCODE=1
wait $CLIENT || EXITCODE=1 

if [ $EXITCODE = 1 ]; do
	grep ^ERROR $SL | sed 's/^/smd-server: /'
	grep ^ERROR $CL | sed 's/^/smd-client: /'
done

exit $EXITCODE
