#!/bin/bash

# the idea is (where == is a bi-directional pipe) :
#
#   ssh foo smd-server == tee log == smd-client
#

set -e
#set -x

. ~/SYNC/smd/smd-common

mycat() { 
	cat 
}

MITM=mycat

if [ "$DEBUG" = "true" ]; then
	MITM=tee
fi

($MITM $CtS > $LtS) < $CtL &
LOGGER1=$!

($MITM $StC > $LtC) < $StL &
LOGGER2=$!

($SMDCLIENT < $LtC 2> $CL) > $CtL &
CLIENT=$!

($SSH $SERVERNAME $SMDSERVER $CLIENTNAME $MAILBOX < $LtS 2> $SL) > $StL &
SERVER=$!

cleanup() {
	rm -f $CONFDIR/lock
	kill $LOGGER1 2>/dev/null || true
	kill $LOGGER2 2>/dev/null || true
	kill $SERVER 2>/dev/null || true
	kill $CLIENT 2>/dev/null || true
}

trap cleanup "EXIT" 

wait $SERVER
wait $CLIENT

