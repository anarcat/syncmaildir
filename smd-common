
if [ `echo $PREFIX | cut -c -1` = "@" ]; then
	SMDSERVER=~/SYNC/syncmaildir/smd-server 
	SMDCLIENT=~/SYNC/syncmaildir/smd-client 
else
	SMDSERVER=$PREFIX/bin/smd-server 
	SMDCLIENT=$PREFIX/bin/smd-client 
fi

H=$HOME
CONFDIR=$H/.smd
SSH=ssh

if [ ! -f $CONFDIR/config ]; then
	mkdir -p $CONFDIR/
	cat > $CONFDIR/config <<- EOT
	# No config file found, this is a template. You want to edit it.

	# Host name to be used with ssh as the server (use ~/.ssh/config 
	# for extra options). smd-pull will pull from this host, smd-push
	# will push to this host and use it as the id of the remote mailbox.
	#
	# We suggest creating an alias with your ~/.ssh/config like:
	# 
	#   Host smd-server-foo
	#     Compression yes
	#     Hostname your.real.server.name
	#     Username you
	#
	SERVERNAME=smd-server-foo

	# Host name to be used as the client. 
	# smd-pull will use this just as an id for the client, while smd-push
	# will ignore it.
	#
	CLIENTNAME=`hostname`

	# The mailbox to sync, the path is the same on both hosts, but
	# can be relative to the current working directory.
	MAILBOX="Mail/"

	# Log client to server and server to client communication.
	# This is useful only for debugging, since all network traffic
	# is dumped, including transmitted mails.
	DEBUG=false
	EOT
	echo No config file found: created a default one
	echo Please edit it: $CONFDIR/config
	exit 1
fi

if [ -f $CONFDIR/lock ]; then
	echo Already running
	exit 1
fi

touch $CONFDIR/lock

. $CONFDIR/config

CtL=$CONFDIR/c2l
LtC=$CONFDIR/l2c
LtS=$CONFDIR/l2s
StL=$CONFDIR/s2l
CtS=$CONFDIR/c2s.log
StC=$CONFDIR/s2c.log
CL=$CONFDIR/client.log
SL=$CONFDIR/server.log

[ -p $CtL ] || mkfifo $CtL 
[ -p $LtC ] || mkfifo $LtC
[ -p $LtS ] || mkfifo $LtS 
[ -p $StL ] || mkfifo $StL

mycat() { 
	cat 
}

MITM=mycat
VERBOSE=

if [ "$DEBUG" = "true" ]; then
	MITM=tee
	VERBOSE=-v
fi

cleanup() {
	rm -f $CONFDIR/lock
	kill $LOGGER1 2>/dev/null || true
	kill $LOGGER2 2>/dev/null || true
	kill $SERVER 2>/dev/null || true
	kill $CLIENT 2>/dev/null || true
}

trap cleanup "EXIT" 

